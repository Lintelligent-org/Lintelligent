name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write # Required for OIDC

jobs:
  build-test:
    name: Build, Test, and Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write # For CodeQL upload
    env:
      DOTNET_NOLOGO: true
      DOTNET_CLI_TELEMETRY_OPTOUT: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore dependencies
        run: dotnet restore Lintelligent.slnx

      - name: Build solution
        run: dotnet build Lintelligent.slnx --configuration Release --no-restore

      - name: Run tests
        run: dotnet test Lintelligent.slnx --configuration Release --no-build --logger trx

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/TestResults/*.trx'
          retention-days: 7

      - name: Run dotnet format (code style & analyzers)
        run: dotnet format Lintelligent.slnx --verify-no-changes

      - name: Dependency Review
        uses: actions/dependency-review-action@v4

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  package:
    name: Pack NuGet Analyzer
    needs: build-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore Lintelligent.slnx

      - name: Build solution
        run: dotnet build Lintelligent.slnx --configuration Release --no-restore

      - name: Pack NuGet package
        run: dotnet pack src/Lintelligent.Analyzers.Basic.Package/Lintelligent.Analyzers.Basic.Package.csproj --configuration Release --no-build --output ./artifacts

      - name: Upload NuGet package artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ./artifacts/*.nupkg
          retention-days: 7

      # Example: Publish to NuGet.org (requires secrets and environment protection)
      # - name: Publish to NuGet.org
      #   run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json
      #   env:
      #     NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

  # Security: Lint workflow file with actionlint
  lint-workflow:
    name: Lint GitHub Actions Workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          echo "${PWD}" >> $GITHUB_PATH
      - name: Run actionlint
        run: actionlint

  # Optionally, SBOM generation for supply chain security
  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      - name: Generate SBOM
        run: dotnet sbom generate --output ./sbom
      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: ./sbom
          retention-days: 30